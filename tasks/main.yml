- name: Ensure dependencies are present.
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - python3-debian
      - gnupg2
    state: present

- name: Download NodeSource's signing key.
  ansible.builtin.get_url:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    dest: /etc/apt/signing-key-nodesource-repo.asc
    owner: root
    group: root
    mode: '0444'
  register: node_signing_key

- name: Add NodeSource repositories for Node.js.
  apt_repository:
    repo: "deb [arch=amd64 signed-by={{ node_signing_key.dest }}] https://deb.nodesource.com/node_21.x nodistro main"
    state: present
  register: node_repo

- name: Update apt cache if repo was added.
  ansible.builtin.apt: update_cache=yes
  when: node_repo is changed
  tags: ['skip_ansible_lint']

- name: Ensure Node.js and npm are installed.
  ansible.builtin.apt:
    name: nodejs
    state: present

- name: Ensure caldera dependencies are present
  apt:
    name: "{{ item }}"
    state: present
    update_cache: yes
  with_items: "{{ caldera_pkg }}"
  register: pkg_result
  until: pkg_result is success

- name: Ensure caldera user exists
  user:
    name: "{{ caldera_user }}"
    home: "{{ caldera_home }}"
    shell: /bin/bash

- name: Ensure recent pip & setuptools in virtualenv
  pip:
    name: "{{ item }}"
    state: present
    virtualenv: "{{ caldera_home }}/env-caldera"
    virtualenv_python: "{{ python }}"
  with_items:
    - pip
    - setuptools
  register: pkg_result
  until: pkg_result is success

- name: git clone caldera
  git:
    repo: https://github.com/mitre/caldera.git
    dest: "{{ caldera_rootdir }}"
    recursive: true
  become: yes
  become_user: "{{ caldera_user }}"
  register: result

- name: Install caldera pip requirements
  pip:
    requirements: "{{ caldera_rootdir }}/requirements.txt"
    virtualenv: "{{ caldera_home }}/env-caldera"
    virtualenv_python: "{{ python }}"
  register: pkg_result
  until: pkg_result is success

- name: Identify other pip requirements
  find:
    paths: "{{ caldera_rootdir }}/plugins"
    patterns: 'requirements.txt'
    recurse: yes
  register: requirements

- name: Install other pip requirements
  pip:
    requirements: "{{ item.path }}"
    virtualenv: "{{ caldera_home }}/env-caldera"
    virtualenv_python: "{{ python }}"
  register: pkg_result
  until: pkg_result is success
  loop: "{{ requirements.files }}"

- name: copy default config to local config
  copy:
    src: "{{ caldera_rootdir }}/conf/default.yml"
    dest: "{{ caldera_rootdir }}/conf/local.yml"
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0644"
    remote_src: true

- name: add plugin to conf
  lineinfile:
    path: "{{ caldera_rootdir }}/conf/local.yml"
    insertafter: 'plugins:'
    line: "- {{ item }}"
  with_items: "{{ plugins }}"

- name: install frontend dependencies
  npm:
    path: "{{ caldera_rootdir }}/plugins/magma/"

- name: build frontend
  command: npm run build
  args:
    chdir: "{{ caldera_rootdir }}/plugins/magma/"

- name: git clone emu
  git:
    repo: https://github.com/mitre/emu.git
    dest: "{{ caldera_rootdir }}/plugins/emu"
    recursive: true
  become: yes
  become_user: "{{ caldera_user }}"
  register: result

- name: git clone emulation plans
  git:
    repo: https://github.com/center-for-threat-informed-defense/adversary_emulation_library
    dest: "{{ caldera_rootdir }}/plugins/emu/data/adversary-emulation-plans"
    recursive: true
  become: yes
  become_user: "{{ caldera_user }}"
  register: result

- name: overwrite download_payloads.sh
  copy:
    src: files/download_payloads.sh
    dest: "{{ caldera_rootdir }}/plugins/emu/download_payloads.sh"
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: run download payloads script
  command: "bash download_payloads.sh"
  args:
    chdir: "{{ caldera_rootdir }}/plugins/emu/"

- name: deploy modified wizard_spider plan
  copy:
    src: wizard_spider.yaml
    dest: "{{ caldera_rootdir }}/plugins/emu/data/adversary-emulation-plans/wizard_spider/Emulation_Plan/yaml/wizard_spider.yaml"
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: deploy modified menuPass plan
  copy:
    src: menupass.yaml
    dest: "{{ caldera_rootdir }}/plugins/emu/data/adversary-emulation-plans/menu_pass/Emulation_Plan/yaml/menupass.yaml"
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: deploy modified sandworm plan
  copy:
    src: sandworm.yaml
    dest: "{{ caldera_rootdir }}/plugins/emu/data/adversary-emulation-plans/sandworm/Emulation_Plan/yaml/sandworm.yaml"
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: create menupass web server directory
  file:
    path: "/tmp/menupass"
    state: directory
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: create menupass exfil directory
  file:
    path: "/tmp/exfil"
    state: directory
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: deploy menupass binaries
  copy:
    src: menupass_binaries.zip
    dest: "/tmp/menupass/YmluYXJpZXM="
    owner: "{{ caldera_user }}"
    group: "{{ caldera_user }}"
    mode: "0755"

- name: install caldera systemd configuration
  template:
    src: systemd-caldera.service.j2
    dest: /lib/systemd/system/caldera.service
    mode: '0644'
    backup: yes
  register: systemd_caldera

- name: install menupass-webserver systemd configuration
  template:
    src: menupass-webserver.service.j2
    dest: /lib/systemd/system/menupass-webserver.service
    mode: '0644'
    backup: yes
  register: systemd_menupass

- name: reload systemd - caldera
  systemd:
    daemon_reload: yes
    name: caldera
  when: systemd_caldera.changed
  ignore_errors: true

- name: reload systemd - menupass webserver
  systemd:
    daemon_reload: yes
    name: caldera
  when: systemd_menupass.changed
  ignore_errors: true

- name: enable and start caldera systemd service
  service:
    name: caldera
    enabled: yes
    state: 'started'
  ignore_errors: true

- name: enable and start menupass webserver systemd service
  service:
    name: menupass-webserver
    enabled: yes
    state: 'started'
  ignore_errors: true
